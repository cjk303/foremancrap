# =========================
# Global settings
# =========================
global
    log /dev/log local0
    log /dev/log local1 notice
    daemon
    maxconn 2000
    tune.bufsize 32768

    # Modern TLS baseline
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-bind-ciphers \
        ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:\
        ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384

# =========================
# Defaults
# =========================
defaults
    log global
    mode http
    option httplog
    option forwardfor
    option http-server-close
    timeout connect 10s
    timeout client 1m
    timeout server 1m
    timeout tunnel 1h        # Keeps WebSockets alive
    http-reuse safe

# =========================
# Frontend
# =========================
frontend main
    bind 10.35.4.10:80
    bind 10.35.4.10:443 ssl crt-list /etc/haproxy/certs/Mainfrontend.crt_list

    # Redirect HTTP â†’ HTTPS
    http-request redirect scheme https code 301 unless { ssl_fc }

    # Route AWX traffic
    acl host_awx hdr(host) -i lnxawx.amer.epiqcorp.com
    use_backend awx_backend if host_awx
    default_backend awx_backend

# =========================
# Backend for AWX
# =========================
backend awx_backend
    mode http
    option forwardfor
    balance roundrobin

    timeout connect 10s
    timeout server 1h
    timeout tunnel 1h

    # --- Normalize headers so Django sees the expected host ---
    http-request del-header Host
    http-request set-header Host lnxawx.amer.epiqcorp.com
    http-request set-header X-Forwarded-Host lnxawx.amer.epiqcorp.com
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port 443

    # --- WebSocket upgrade support ---
    acl is_websocket hdr(Upgrade) -i WebSocket
    acl hdr_connection_upgrade hdr(Connection) -i upgrade
    use-server awx if is_websocket or hdr_connection_upgrade
    option http-keep-alive

    server awx 10.35.4.40:30080 check inter 5s fall 3 rise 2
